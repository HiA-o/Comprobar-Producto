<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qu√© Comes - Analizador de Alimentos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1020;
      --card: #131a33;
      --muted: #9aa3b2;
      --accent: #7cd992;
      --bad: #ef6262;
      --warn: #ffb020;
      --ok: #6cb4ff;
      --good: #7ee081;
      --text: #e5eef7;
      --border: #243056;
      --input-bg: #0b1328;
      --input-border: #33406a;
      --placeholder: #7b86a6;
      --button-bg: #1e2a52;
      --button-border: #2a3a6d;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Roboto', system-ui, sans-serif;
      background: linear-gradient(180deg, var(--bg) 0%, #0f1530 100%);
      color: var(--text);
      line-height: 1.5;
    }
    header {
      padding: 2.5rem 1rem 1rem;
      text-align: center;
    }
    h1 {
      margin: 0;
      font-size: clamp(2rem, 4vw, 3rem);
      letter-spacing: 0.4px;
    }
    p.sub {
      margin: 0.5rem 0 0;
      color: var(--muted);
      font-size: 1rem;
    }
    main {
      max-width: 1100px;
      margin: 1.5rem auto 3.5rem;
      padding: 0 1rem;
    }
    .panel {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: 1.3fr 0.7fr;
    }
    @media (max-width: 980px) {
      .panel { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(5, 10, 30, 0.45);
      padding: 1.5rem;
    }
    .card h2 {
      font-size: 1.25rem;
      margin: 0 0 1rem;
    }
    label {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }
    input[type=text] {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      outline: none;
    }
    input[type=text]::placeholder { color: var(--placeholder); }
    .row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .row > * { flex: 1; }
    button {
      appearance: none;
      border: none;
      cursor: pointer;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      font-weight: 700;
      letter-spacing: 0.2px;
      background: var(--button-bg);
      color: var(--text);
      border: 1px solid var(--button-border);
      transition: filter 0.2s;
    }
    button:hover { filter: brightness(1.1); }
    .primary {
      background: linear-gradient(180deg, #2d6df6, #1f59cf);
      border-color: #1c4aa9;
    }
    .ghost { background: transparent; }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.75rem;
      color: #c8d1e3;
      padding: 0.4rem 0.6rem;
      border-radius: 999px;
      background: #0e1530;
      border: 1px solid #2c3a6a;
    }
    .scoreWrap {
      display: flex;
      gap: 1.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .score {
      font-size: 3.5rem;
      font-weight: 800;
      line-height: 1;
    }
    .score.bad { color: var(--bad); }
    .score.ok { color: var(--warn); }
    .score.good { color: var(--good); }
    .tag { font-weight: 700; color: #a9b4c9; }
    .grid {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    @media (max-width: 700px) {
      .grid { grid-template-columns: 1fr; }
    }
    .kv {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      padding: 0.6rem 0.8rem;
      border-radius: 0.75rem;
      background: #0c1530;
      border: 1px solid #25335f;
    }
    .kv .k { color: #a4afc8; font-size: 0.8rem; }
    .kv .v { font-weight: 700; }
    .list { display: grid; gap: 0.6rem; }
    .pill {
      padding: 0.7rem 0.8rem;
      border-radius: 0.75rem;
      background: #0c1530;
      border: 1px solid #273768;
    }
    .pill .title { font-weight: 700; }
    .pill.small { font-size: 0.8rem; }
    .warn { color: var(--warn); }
    .bad { color: var(--bad); }
    .good { color: var(--good); }
    .muted { color: var(--muted); }
    .flex {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .flex-col {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .divider {
      height: 1px;
      background: #25335f;
      margin: 1rem 0;
    }
    .foot {
      font-size: 0.75rem;
      color: #9aa8c2;
      text-align: center;
      margin-top: 1.5rem;
    }
    .tiny { font-size: 0.75rem; color: #9db0cf; }
    .tooltip {
      border-bottom: 1px dotted #7385af;
      cursor: help;
    }
    .right { justify-content: flex-end; }
    .scorebar {
      height: 0.75rem;
      border-radius: 999px;
      background: #0b1328;
      border: 1px solid #33406a;
      position: relative;
      overflow: hidden;
    }
    .scorebar > i {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0;
      background: linear-gradient(90deg, var(--bad), var(--warn), var(--good));
      transition: width 0.5s ease-out;
    }
    .badge {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #2b3967;
      background: #0c1530;
      color: #c9d2e7;
    }
    .notes {
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 0.75rem;
      background: #0a1226;
      border: 1px dashed #2d3d71;
      padding: 0.8rem;
      border-radius: 0.75rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .history-btn {
      background: #1e2a52;
      border: 1px solid #2a3a6d;
      color: #e5eef7;
      font-weight: 400;
      font-size: 0.9rem;
      padding: 0.5rem 0.8rem;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .history-btn:hover {
      background: #253567;
    }
    .history-container {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .history-container.empty {
        display: none;
    }
    .warning-message {
      background-color: var(--warn);
      color: var(--bg);
      padding: 10px;
      border-radius: 5px;
      margin-top: 20px;
      text-align: center;
      font-weight: bold;
      display: none;
    }
    #reasons {
      list-style-type: none;
      padding: 0;
      margin: 0.75rem 0 0;
    }
    #reasons li {
      background: #0c1530;
      border: 1px solid #273768;
      padding: 0.7rem 0.8rem;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      margin-bottom: 0.6rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Qu√© Comes - Analizador de Alimentos</h1>
    <p class="sub">Pega el c√≥digo de barras o la URL de <b>Open Food Facts</b>, y te doy un resumen + <span class="tooltip" title="Reglas heur√≠sticas basadas en az√∫car, grasas, sal, NOVA, aditivos y otros">nota de saludabilidad</span>.</p>
  </header>
  <main>
    <section class="panel">
      <div class="card">
        <h2>üîç Entrada</h2>
        <label for="input">C√≥digo de barras (EAN) o URL del producto</label>
        <div class="row">
          <input id="input" type="text" placeholder="Ej.: 8410100082930 o https://es.openfoodfacts.org/producto/8410100082930" />
          <button class="primary" id="go">Analizar</button>
        </div>
        <div class="row" style="margin-top:0.75rem">
          <button id="demoYogurt" class="ghost">Probar con Yogur üçì</button>
          <button id="demoNatillas" class="ghost">Probar con Natillas üçÆ</button>
          <button id="demoGalletas" class="ghost">Probar con Galletas üç™</button>
        </div>
        <div id="history" class="history-container empty">
          <div class="muted" style="font-size:0.8rem; margin-right:0.5rem;">Historial reciente:</div>
        </div>
      </div>
      <div class="card">
        <h2>‚ú® Nota de saludabilidad</h2>
        <div class="scoreWrap">
          <div class="score bad" id="score">‚Äî</div>
          <div>
            <div id="scoreLabel" class="tag">‚Äî</div>
            <div class="scorebar" style="margin-top:0.5rem"><i id="scoreBar"></i></div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="grid">
          <div class="kv"><div class="k">Nutri-Score</div><div class="v" id="nutri">‚Äî</div></div>
          <div class="kv"><div class="k">NOVA (procesado)</div><div class="v" id="nova">‚Äî</div></div>
          <div class="kv"><div class="k">Aditivos</div><div class="v" id="additivesCount">‚Äî</div></div>
          <div class="kv"><div class="k">Az√∫cares /100g</div><div class="v" id="sugars">‚Äî</div></div>
          <div class="kv"><div class="k">Grasas sat. /100g</div><div class="v" id="sats">‚Äî</div></div>
          <div class="kv"><div class="k">Sal /100g</div><div class="v" id="salt">‚Äî</div></div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:1.5rem">
        <div id="result-container">
            <div class="flex right"><button id="copy" class="ghost">Copiar resumen</button></div>
            <div class="flex">
                <img id="img" alt="imagen" style="width:5.5rem; height:5.5rem; object-fit:cover; border-radius:0.75rem; border:1px solid #2a3966; background:#0a1226;" />
                <div class="flex-col">
                    <div style="font-weight:800; font-size:1.25rem" id="title">‚Äî</div>
                    <div class="tiny" id="brand">‚Äî</div>
                    <div class="tiny" id="cat">‚Äî</div>
                    <div class="flex" style="margin-top:0.4rem; gap:0.4rem">
                        <span id="nutriBadge" class="badge" style="display:none"></span>
                        <span id="novaBadge" class="badge" style="display:none"></span>
                        <span id="ecoBadge" class="badge" style="display:none"></span>
                    </div>
                </div>
            </div>
            <div class="divider"></div>
            <h2>üö¶ Se√±ales clave</h2>
            <div class="grid">
                <div class="pill"><div class="title">Ingredientes</div><div class="muted" id="ing">‚Äî</div></div>
                <div class="pill"><div class="title">Nutrientes /100g</div><div class="muted" id="nutr"></div></div>
            </div>
            <div class="divider"></div>
            <h2>üß™ Aditivos y evaluaci√≥n</h2>
            <div class="list" id="additivesList"><div class="muted">‚Äî</div></div>
            <div class="divider"></div>
            <h2>üìù Motivos de la nota</h2>
            <div id="warning-message" class="warning-message"></div>
            <ul id="reasons"></ul>
        </div>
        <div class="divider"></div>
        <details>
            <summary class="tiny">Depuraci√≥n (detalles t√©cnicos)</summary>
            <pre class="notes" id="debug">‚Äî</pre>
        </details>
        <p class="foot">Fuente de datos: Open Food Facts (API p√∫blica). Esta herramienta no almacena nada. ¬∑ <a href="faq.html" style="color:var(--muted); text-decoration:underline;">Preguntas frecuentes y metodolog√≠a</a></p>
    </section>
  </main>
  <script>
    const $ = s => document.querySelector(s);
    const fmt = n => (n == null || isNaN(n)) ? '‚Äî' : (Math.round(n * 10) / 10).toString();
    const clamp = (x, a, b) => Math.min(Math.max(x, a), b);

    // --- BASE DE DATOS MEJORADA DE ADITIVOS CON NOTAS ---
    const controversial = {
      'en:e100': { level: 'baja', note: 'Colorante (curcumina). Generalmente seguro, puede interactuar con algunos antibi√≥ticos.' },
      'en:e102': { level: 'alta', note: 'Tartrazina. Colorante amarillo sint√©tico. Se ha asociado con hiperactividad en ni√±os y puede causar alergias.' },
      'en:e104': { level: 'alta', note: 'Amarillo de quinole√≠na. Colorante sint√©tico. Prohibido en varios pa√≠ses por su relaci√≥n con alergias e hiperactividad.' },
      'en:e110': { level: 'alta', note: 'Amarillo ocaso. Colorante sint√©tico. Vinculado a hiperactividad en ni√±os y reacciones al√©rgicas. Prohibido en algunos pa√≠ses.' },
      'en:e120': { level: 'media', note: 'Cochinilla. Colorante rojo de origen animal. Puede causar alergias y asma en personas sensibles.' },
      'en:e122': { level: 'alta', note: 'Azorrubina. Colorante sint√©tico rojo. Se ha asociado con hiperactividad infantil y asma.' },
      'en:e124': { level: 'alta', note: 'Rojo cochinilla A. Colorante sint√©tico. Vinculado a la hiperactividad en ni√±os y urticaria.' },
      'en:e129': { level: 'alta', note: 'Rojo allura AC. Colorante sint√©tico. Asociado con hiperactividad en ni√±os. Prohibido en varios pa√≠ses de Europa.' },
      'en:e131': { level: 'alta', note: 'Azul patentado V. Colorante sint√©tico. Potencialmente alerg√©nico.' },
      'en:e132': { level: 'media', note: 'Indigotina. Colorante sint√©tico. Puede causar alergias y n√°useas.' },
      'en:e133': { level: 'media', note: 'Azul brillante FCF. Colorante sint√©tico. Se asocia con alergias y posible hiperactividad.' },
      'en:e150d': { level: 'media', note: 'Colorante (caramelo de sulfito am√≥nico). Se recomienda limitar su consumo.' },
      'en:e151': { level: 'alta', note: 'Negro brillante BN. Colorante sint√©tico. Prohibido en varios pa√≠ses por sospechas de carcinogenicidad.' },
      'en:e160b': { level: 'media', note: 'Colorante (annatto). En raras ocasiones se ha asociado con reacciones al√©rgicas.' },
      'en:e160bii': { level: 'media', note: 'Bixina. Subtipo de Annatto. En raras ocasiones se ha asociado con reacciones al√©rgicas.' },
      'en:e171': { level: 'alta', note: 'Di√≥xido de titanio. Colorante blanco. Se ha prohibido en la UE por riesgo genot√≥xico.' },
      'en:e202': { level: 'baja', note: 'Sorbato de potasio. Conservante. Generalmente seguro, aunque puede causar reacciones cut√°neas.' },
      'en:e211': { level: 'media', note: 'Benzoato de sodio. Conservante. Puede causar reacciones al√©rgicas y, combinado con vitamina C, puede generar benceno (carcin√≥geno).' },
      'en:e223': { level: 'media', note: 'Conservante (sulfitos). Puede causar reacciones en personas sensibles (al√©rgicos y asm√°ticos).' },
      'en:e250': { level: 'alta', note: 'Nitrito s√≥dico. Conservante en c√°rnicos curados. Se asocia con la formaci√≥n de nitrosaminas, que son cancer√≠genas.' },
      'en:e251': { level: 'media', note: 'Nitrato s√≥dico. Conservante que se convierte en nitrito en el cuerpo.' },
      'en:e304': { level: 'baja', note: 'Palmitato de ascorbilo. Antioxidante derivado de la vitamina C y el √°cido palm√≠tico. Generalmente considerado seguro. Podr√≠a no ser apto para veganos si el √°cido palm√≠tico proviene de grasa animal.' },
      'en:e306': { level: 'baja', note: 'Extracto de tocoferoles. Antioxidante natural derivado de aceites vegetales (vitamina E). Generalmente considerado seguro por las autoridades sanitarias.' },
      'en:e320': { level: 'alta', note: 'BHA. Antioxidante sint√©tico. Considerado un posible carcin√≥geno y disruptor endocrino.' },
      'en:e321': { level: 'alta', note: 'BHT. Antioxidante sint√©tico. Considerado un posible carcin√≥geno y disruptor endocrino.' },
      'en:e322': { level: 'baja', note: 'Lecitina. Emulsionante de origen natural (soja, girasol, huevo). Generalmente seguro, aunque las personas al√©rgicas a la soja o el huevo deben verificar la fuente.' },
      'en:e322i': { level: 'baja', note: 'Lecitina. Emulsionante de origen natural. Variante de E322, con propiedades y riesgos id√©nticos. Generalmente considerado seguro.' },
      'en:e327': { level: 'baja', note: 'Lactato de calcio. Regulador de acidez y fuente de calcio. Generalmente se considera seguro.' },
      'en:e330': { level: 'baja', note: '√Åcido c√≠trico. Regulador de acidez y antioxidante natural. Se encuentra com√∫nmente en frutas c√≠tricas.' },
      'en:e331': { level: 'baja', note: 'Citrato de sodio. Regulador de acidez y antioxidante. Generalmente considerado seguro.' },
      'en:e331iii': { level: 'baja', note: 'Citrato tris√≥dico. Regulador de acidez y conservante. Generalmente considerado seguro.' },
      'en:e407': { level: 'alta', note: 'Carragenanos. Espesante controvertido. Algunos estudios lo asocian con inflamaci√≥n intestinal.' },
      'en:e412': { level: 'baja', note: 'Goma guar. Espesante. Generalmente seguro, pero en grandes cantidades puede causar malestar intestinal.' },
      'en:e415': { level: 'baja', note: 'Goma xantana. Espesante y estabilizante. Generalmente considerado seguro.' },
      'en:e420': { level: 'baja', note: 'Sorbitol. Edulcorante y agente de carga. Un consumo excesivo puede tener efectos laxantes.' },
      'en:e420ii': { level: 'baja', note: 'Jarabe de sorbitol. Un edulcorante de carga con menos calor√≠as que el az√∫car. Un consumo excesivo puede tener efectos laxantes.' },
      'en:e440': { level: 'baja', note: 'Pectinas. Espesante y gelificante natural que se extrae de frutas. Se considera inofensivo.' },
      'en:e450': { level: 'media', note: 'Difosfatos. Emulsionantes y estabilizantes. Se usan para mejorar la textura de quesos o embutidos. Su consumo en exceso puede interferir con la absorci√≥n de calcio.' },
      'en:e450i': { level: 'baja', note: 'Difosfato de sodio. Un emulsionante y estabilizante que ayuda a mantener la textura de carnes procesadas, quesos y productos horneados. Consumo moderado recomendado.' },
      'en:e450v': { level: 'baja', note: 'Difosfato de pentasodio. Fosfato utilizado como emulsionante y estabilizante en productos c√°rnicos, pescados y quesos procesados. Consumo moderado recomendado' },
      'en:e466': { level: 'baja', note: 'Carboximetilcelulosa. Espesante. Puede afectar a la flora intestinal y se asocia con inflamaci√≥n en algunos estudios.' },
      'en:e471': { level: 'baja', note: 'Mono y diglic√©ridos de √°cidos grasos. Emulsionante. Se utiliza en productos de panader√≠a, helados y margarinas. Generalmente considerados seguros.' },
      'en:e472e': { level: 'baja', note: '√âsteres de monoglic√©ridos y diglic√©ridos de √°cidos grasos. Emulsionante. Se usa para mejorar la textura de los alimentos. Considerado seguro para el consumo humano.' },
      'en:e500': { level: 'baja', note: 'Bicarbonato de sodio. Agente leudante. Generalmente seguro, pero personas con dietas bajas en sodio o problemas renales deben moderar su consumo.' },
      'en:e500ii': { level: 'baja', note: 'Carbonato √°cido de sodio. Agente leudante y regulador de acidez, generalmente considerado seguro.' },
      'en:e503': { level: 'baja', note: 'Carbonato de amonio. Agente leudante. Considerado seguro ya que se descompone completamente durante el horneado y no deja residuos en el producto final.' },
      'en:e503ii': { level: 'baja', note: 'Carbonato √°cido de amonio. Agente leudante. Se descompone completamente durante el horneado, no dejando residuos en el producto final. Generalmente considerado seguro.' },
      'en:e508': { level: 'baja', note: 'Cloruro de potasio. Un estabilizante y gelificante, a menudo usado como sustituto de la sal para reducir el sodio. Considerado seguro.' },
      'en:e621': { level: 'media', note: 'Glutamato monos√≥dico (MSG). Potenciador del sabor. Se ha relacionado con el "s√≠ndrome del restaurante chino" y efectos en personas sensibles.' },
      'en:e627': { level: 'media', note: 'Guanilato dis√≥dico. Potenciador del sabor. Su consumo debe ser moderado.' },
      'en:e631': { level: 'media', note: 'Inosinato dis√≥dico. Potenciador del sabor. No apto para veganos ni vegetarianos.' },
      'en:e950': { level: 'media', note: 'Acesulfamo K. Edulcorante artificial. Considerado seguro por la mayor√≠a de las agencias de salud.' },
      'en:e951': { level: 'media', note: 'Aspartamo. Edulcorante artificial. Genera controversia, pero ha sido considerado seguro por la EFSA.' },
      'en:e952': { level: 'media', note: 'Ciclamato. Un edulcorante artificial sint√©tico que es m√°s dulce que el az√∫car. Genera cierta controversia, pero est√° aprobado para su uso en la UE.' },
      'en:e954': { level: 'media', note: 'Sacarina. Edulcorante artificial.' },
      'en:e955': { level: 'media', note: 'Sucralosa. Edulcorante artificial. Genera debate, pero ha sido considerada segura por las principales autoridades sanitarias. Se recomienda un consumo moderado.' },
      'en:e965': { level: 'baja', note: 'Maltitol. Edulcorante de carga (poliol) con menos calor√≠as que el az√∫car. En grandes cantidades puede causar efectos laxantes.' },
      'en:e966': { level: 'baja', note: 'Lactitol. Un edulcorante de carga y agente de volumen. Es un poliol que, en exceso, puede tener efectos laxantes.' },
      'en:e968': { level: 'baja', note: 'Eritritol. Un edulcorante natural que se encuentra en frutas. No tiene calor√≠as y no afecta los niveles de glucosa en sangre, pero un consumo excesivo puede causar malestar digestivo.' },
      'en:e1414': { level: 'baja', note: 'Almid√≥n modificado. Espesante y estabilizante. Proviene del almid√≥n de ma√≠z o patata, es un derivado natural, generalmente considerado seguro.' },
    };

    let additivesTaxonomy = null;
    async function loadAdditivesTaxonomy() {
      if (additivesTaxonomy) return additivesTaxonomy;
      try {
        const res = await fetch('https://static.openfoodfacts.org/data/taxonomies/additives.json', { mode: 'cors' });
        additivesTaxonomy = await res.json();
      } catch (e) {
        console.warn('No se pudo cargar la taxonom√≠a de aditivos', e);
        additivesTaxonomy = {};
      }
      return additivesTaxonomy;
    }

    const tagToEcode = tag => tag?.split(':').pop()?.toUpperCase() || '';
    const gradeColor = score => score >= 8 ? 'good' : score >= 6 ? 'ok' : 'bad';
    const percentBar = score => (score / 10 * 100).toFixed(1) + '%';
    const nutriBadge = g => g ? `Nutri-Score ${('' + g).toUpperCase()}` : '';
    const novaBadge = n => n ? `NOVA ${n}` : '';

    function computeHealthScore(p) {
      const N = p.nutriments || {};
      const sugars = N.sugars_100g ?? N.sugars ?? null;
      const sat = N['saturated-fat_100g'] ?? N['saturated-fat'] ?? null;
      const trans = N['trans-fat_100g'] ?? N['trans-fat'] ?? null;
      const salt = N.salt_100g ?? N.salt ?? (N.sodium_100g ? N.sodium_100g * 2.5 : null);
      const fiber = N.fiber_100g ?? N.fiber ?? null;
      const protein = N.proteins_100g ?? N.proteins ?? null;
      const nova = p.nova_group || p.nova_groups || null;
      const kcal = N['energy-kcal_100g'] ?? N.energy_100g / 4.184 ?? null;

      let score = 10;
      const reasons = [];

      // Penalizaciones y bonificaciones
      if (nova) {
        if (nova == 4) { score -= 3.0; reasons.push(`NOVA 4 (ultraprocesado) ‚Üí -3.0`); }
        else if (nova == 3) { score -= 1.8; reasons.push('NOVA 3 (procesado) ‚Üí -1.8'); }
      }
      if (sugars != null) {
        if (sugars > 30) { score -= 4.0; reasons.push(`Az√∫car ${fmt(sugars)} g/100g (muy muy alto >30g) ‚Üí -4.0`); }
        else if (sugars > 12) { score -= 3.0; reasons.push(`Az√∫car ${fmt(sugars)} g/100g (muy alto >12g) ‚Üí -3.0`); }
        else if (sugars > 8) { score -= 2.0; reasons.push(`Az√∫car ${fmt(sugars)} g/100g (alto >8g) ‚Üí -2.0`); }
        else if (sugars > 5) { score -= 1.0; reasons.push(`Az√∫car ${fmt(sugars)} g/100g (medio >5g) ‚Üí -1.0`); }
        else if (sugars > 2) { score -= 0.5; reasons.push(`Az√∫car ${fmt(sugars)} g/100g (bajo >2g) ‚Üí -0.5`); }
        else if (sugars === 0) { score += 0.4; reasons.push('Sin az√∫cares ‚Üí +0.4'); }
      }
      if (sat != null) {
        if (sat > 8) { score -= 2.5; reasons.push(`Grasas sat. ${fmt(sat)} g/100g (muy alto >8g) ‚Üí -2.5`); }
        else if (sat > 5) { score -= 1.5; reasons.push(`Grasas sat. ${fmt(sat)} g/100g (alto >5g) ‚Üí -1.5`); }
        else if (sat > 2) { score -= 0.5; reasons.push(`Grasas sat. ${fmt(sat)} g/100g (medio >2g) ‚Üí -0.5`); }
        else if (sat <= 1) { score += 0.2; reasons.push('Grasas sat. bajas (<1g) ‚Üí +0.2'); }
      }
      if (trans != null && trans > 0.5) {
        score -= 4.0;
        reasons.push(`Grasas trans (${fmt(trans)} g/100g) ‚Üí -4.0`);
      }
      if (salt != null) {
        if (salt > 2) { score -= 2.5; reasons.push(`Sal ${fmt(salt)} g/100g (muy muy alta >2g) ‚Üí -2.5`); }
        else if (salt > 1.5) { score -= 2.0; reasons.push(`Sal ${fmt(salt)} g/100g (muy alta >1.5g) ‚Üí -2.0`); }
        else if (salt > 0.9) { score -= 1.2; reasons.push(`Sal ${fmt(salt)} g/100g (alta >0.9g) ‚Üí -1.2`); }
        else if (salt > 0.6) { score -= 0.4; reasons.push(`Sal ${fmt(salt)} g/100g (media >0.6g) ‚Üí -0.4`); }
        else if (salt < 0.12) { score += 0.2; reasons.push('Sal muy baja (<0.12g) ‚Üí +0.2'); }
      }
      if (kcal != null) {
        if (kcal > 500) { score -= 1.5; reasons.push(`Alto valor cal√≥rico (${fmt(kcal)} kcal/100g) ‚Üí -1.5`); }
        else if (kcal > 400) { score -= 1.0; reasons.push(`Valor cal√≥rico elevado (${fmt(kcal)} kcal/100g) ‚Üí -1.0`); }
        else if (kcal > 300) { score -= 0.5; reasons.push(`Valor cal√≥rico medio (${fmt(kcal)} kcal/100g) ‚Üí -0.5`); }
        else if (kcal <= 50) { score += 0.5; reasons.push(`Energ√≠a muy baja (${fmt(kcal)} kcal) ‚Üí +0.5`); }
      }
      if (fiber != null) {
        if (fiber >= 6) { score += 1.0; reasons.push('Fibra ‚â•6 g/100g ‚Üí +1.0'); }
        else if (fiber >= 3) { score += 0.5; reasons.push('Fibra ‚â•3 g/100g ‚Üí +0.5'); }
      }
      if (protein != null) {
        if (protein >= 8) { score += 0.5; reasons.push('Prote√≠na ‚â•8 g/100g ‚Üí +0.5'); }
        else if (protein < 3) { score -= 0.4; reasons.push('Prote√≠na baja ‚Üí -0.4'); }
      }
      const fvn = p['fruits-vegetables-nuts_100g'] ?? p.fruits_vegetables_nuts_estimate_100g ?? null;
      if (fvn != null) {
        if (fvn >= 40) { score += 0.6; reasons.push('Buena proporci√≥n de FVH ‚Üí +0.6'); }
        else if (fvn === 0) { score -= 0.8; reasons.push('0% fruta/verdura/nueces ‚Üí -0.8'); }
      }
      
      // Bonificaciones por micronutrientes
      const micronutrients = {
        'calcium_100g': 0.08, 'iron_100g': 0.08, 'vitamin-c_100g': 0.08, 'vitamin-d_100g': 0.08
      };
      for (const k in micronutrients) {
        const v = N[k];
        if (v != null && v >= micronutrients[k]) {
          const m = k.split('_')[0].replace('-', ' ');
          score += 0.2;
          reasons.push(`Contenido significativo de ${m} ‚Üí +0.2`);
        }
      }

      // Penalizaci√≥n por alcohol y cafe√≠na
      const alcohol = N.alcohol_100g ?? null;
      const caffeine = N.caffeine_100g ?? null;
      if (alcohol != null && alcohol > 0) {
        score -= 2.0; reasons.push(`Contiene alcohol (${fmt(alcohol)}%) ‚Üí -2.0`);
      }
      if (caffeine != null && caffeine > 0) {
        score -= 1.0; reasons.push(`Contiene cafe√≠na ‚Üí -1.0`);
      }


      const adds = p.additives_tags || [];
      if (adds.length >= 6) { score -= 2.0; reasons.push(`Muchos aditivos (${adds.length}) ‚Üí -2.0`); }
      else if (adds.length >= 3) { score -= 1.0; reasons.push(`Varios aditivos (${adds.length}) ‚Üí -1.0`); }
      let controversialHits = 0;
      let highFlag = false;
      for (const t of adds) {
        if (controversial[t]) {
          controversialHits++;
          if (controversial[t].level === 'alta') { score -= 1.5; highFlag = true; }
          else { score -= 0.8; }
        }
      }
      if (controversialHits > 0) { reasons.push(`Aditivos controvertidos: ${controversialHits}${highFlag ? ' (incluye ALTA)' : ''}`); }
      
      const ingTxt = (p.ingredients_text_es || p.ingredients_text || '').toLowerCase();
      if (ingTxt.includes('aroma')) {
        const hasFruitWord = /(fresa|frambuesa|manzana|pl√°tano|banana|pera|melocot√≥n|cacao|vainilla|lim√≥n|naranja|uva|fruta)/.test(ingTxt);
        if (!hasFruitWord) { score -= 0.8; reasons.push('Aromas a√±adidos sin fruta destacada ‚Üí -0.8'); }
        else { score -= 0.5; reasons.push('Aromas a√±adidos ‚Üí -0.5'); }
      }
      
      const nutriGrade = p.nutriscore_grade || p.nutrition_grades || p.nutrition_grade_fr || null;
      if (nutriGrade) {
        const g = ('' + nutriGrade).toLowerCase();
        const adj = { 'a': +1.2, 'b': +0.8, 'c': -1.0, 'd': -2.0, 'e': -3.0 }[g];
        if (adj) { score += adj; reasons.push(`Nutri-Score ${g.toUpperCase()} ‚Üí ${adj > 0 ? '+' : ''}${adj}`); }
      }

      score = clamp(Math.round(score * 10) / 10, 1, 10);
      let label = 'Mejor evitar';
      if (score >= 8) label = 'Excelente para consumir';
      else if (score >= 6) label = 'Consumo moderado';
      else if (score >= 4) label = 'Ocasional';

      return { score, label, sugars, sat, salt, fiber, protein, nova, reasons };
    }

    function updateUI(p, s) {

      // Score section
      document.getElementById('result-container').style.display = 'block';
      const scoreEl = $('#score');
      const score = s.score.toFixed(1);
      scoreEl.textContent = score;
      scoreEl.classList.remove('bad', 'ok', 'good');
      scoreEl.classList.add(gradeColor(s.score));
      $('#scoreLabel').textContent = s.label;
      $('#scoreBar').style.width = percentBar(s.score);
      
      $('#nutri').textContent = p.nutriscore_grade || p.nutrition_grades || p.nutrition_grade_fr || '‚Äî';
      $('#nova').textContent = p.nova_group || p.nova_groups || '‚Äî';
      $('#additivesCount').textContent = (p.additives_tags || []).length;
      $('#sugars').textContent = fmt(s.sugars) + ' g';
      $('#sats').textContent = fmt(s.sat) + ' g';
      $('#salt').textContent = fmt(s.salt) + ' g';

      // Product basics
      $('#title').textContent = p.product_name_es || p.product_name || 'Producto sin nombre';
      $('#brand').textContent = p.brands || '‚Äî';
      $('#cat').textContent = p.categories || '‚Äî';
      $('#img').src = p.image_small_url || p.image_url || '';

      const g = p.nutriscore_grade || p.nutrition_grades || p.nutrition_grade_fr;
      const n = p.nova_group || p.nova_groups;
      $('#nutriBadge').style.display = g ? 'inline-block' : 'none';
      if (g) $('#nutriBadge').textContent = nutriBadge(g);
      $('#novaBadge').style.display = n ? 'inline-block' : 'none';
      if (n) $('#novaBadge').textContent = novaBadge(n);

      // Etiquetas org√°nicas
      const ecoTags = p.labels_tags || [];
      const isEco = ecoTags.some(t => t === 'en:organic' || t === 'es:ecologico' || t === 'en:bio');
      $('#ecoBadge').style.display = isEco ? 'inline-block' : 'none';
      if (isEco) $('#ecoBadge').textContent = 'Org√°nico / Bio';

      // Ingredients & nutrients
      const ingredientsText = (p.ingredients_text_es || p.ingredients_text || '‚Äî');
      const cleanedIngredients = ingredientsText.replace(/_/g, '');
      $('#ing').textContent = cleanedIngredients;
      const N = p.nutriments || {};
      $('#nutr').innerHTML = [
        N['energy-kcal_100g'] ? `Energ√≠a: ${fmt(N['energy-kcal_100g'])} kcal` : null,
        N.fat_100g != null ? `Grasa: ${fmt(N.fat_100g)} g` : null,
        N['saturated-fat_100g'] != null ? `Sat.: ${fmt(N['saturated-fat_100g'])} g` : null,
        N['trans-fat_100g'] != null ? `Trans.: ${fmt(N['trans-fat_100g'])} g` : null,
        N.carbohydrates_100g != null ? `Hidratos: ${fmt(N.carbohydrates_100g)} g` : null,
        N.sugars_100g != null ? `Az√∫cares: ${fmt(N.sugars_100g)} g` : null,
        N.fiber_100g != null ? `Fibra: ${fmt(N.fiber_100g)} g` : null,
        N.proteins_100g != null ? `Prote√≠nas: ${fmt(N.proteins_100g)} g` : null,
        N.salt_100g != null ? `Sal: ${fmt(N.salt_100g)} g` : (N.sodium_100g != null ? `Sodio: ${fmt(N.sodium_100g)} g` : null)
      ].filter(Boolean).join(' ¬∑ ');

      // Additives
      const list = $('#additivesList');
      list.innerHTML = '';
      const tags = p.additives_tags || [];

      if (tags.length === 0) {
        list.innerHTML = '<div class="muted">Sin aditivos declarados.</div>';
      } else {
        const tax = additivesTaxonomy || {};
        tags.forEach(t => {
          const info = tax[t] || {};
          const name = (info.name_es || info.name_es_es || info.name_en || {});
          const disp = typeof name === "string" ? name : (name?.es || name?.en || name?.fr || tagToEcode(t));
          const cont = controversial[t];
          
          const extra = [];
          const risk = info.efsa_evaluation_overexposure_risk || info.efsa_evaluation || null;
          if (risk) {
            let riskText = 'Evaluaci√≥n EFSA.';
            if (typeof risk === "string") {
              if (risk.toLowerCase().includes('re-evaluation')) { riskText = 'EFSA: En re-evaluaci√≥n o ya evaluado.'; }
              else if (risk.toLowerCase().includes('safe')) { riskText = 'EFSA: Considerado seguro.'; }
            }
            extra.push(riskText);
          }

          const veg = info.vegan || info.vegetarian || null;
          if (veg) {
            const vegNote = typeof veg === "string" ? veg : (veg?.en || '');
            if (vegNote.toLowerCase().includes('no')) { extra.push('No apto para veganos/vegetarianos'); }
            else if (vegNote.toLowerCase().includes('yes')) { extra.push('Apto para veganos/vegetarianos'); }
          }

          // **NUEVO: L√≥gica mejorada para mostrar la nota del aditivo**
          if (cont) {
            extra.push(`Nota: ${cont.note}`);
          } else {
            extra.push('Sin informaci√≥n adicional.');
          }

          const html = `<div class="pill small"><div class="title">${tagToEcode(t)} ‚Äî ${disp || tagToEcode(t)}</div><div class="tiny">${extra.join(' ¬∑ ') || 'Sin informaci√≥n adicional.'}</div></div>`;
          list.insertAdjacentHTML('beforeend', html);
        });
      }

      // Reasons
      const reasonsBox = $('#reasons');
      const warningMessageDiv = $('#warning-message');
      reasonsBox.innerHTML = '';
      
      const ingredientWarning = (!p.ingredients_text_es && !p.ingredients_text);
      if (ingredientWarning) {
        warningMessageDiv.style.display = 'block';
        warningMessageDiv.textContent = '‚ö†Ô∏è Nota basada en datos incompletos. No se han encontrado ingredientes para este producto. La puntuaci√≥n podr√≠a no ser precisa.';
      } else {
        warningMessageDiv.style.display = 'none';
      }
      
      if (s.reasons.length > 0) {
        s.reasons.forEach(reason => {
          const li = document.createElement('li');
          li.textContent = reason;
          reasonsBox.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'Sin penalizaciones o bonificaciones espec√≠ficas.';
        reasonsBox.appendChild(li);
      }

      // Debug
      const debugData = {
        product: { code: p.code, name: p.product_name, nutri: g, nova: n },
        nutriments: { ...N },
        additives_tags: p.additives_tags || [],
        reasons: s.reasons,
        score: s.score
      };
      $('#debug').textContent = JSON.stringify(debugData, null, 2);
    }

    const parseCode = input => {
      input = (input || '').trim();
      if (!input) return null;
      if (input.startsWith('http')) {
        try {
          const u = new URL(input);
          const m = u.pathname.match(/(\d{8,14})/);
          return m?.[1] || null;
        } catch (e) { return null; }
      }
      const m = input.match(/^(\d{8,14})$/);
      return m?.[1] || null;
    };

    async function fetchProduct(code) {
      const url = `https://world.openfoodfacts.org/api/v2/product/${code}.json`;
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error('Error al conectar con Open Food Facts.');
      const j = await res.json();
      if (j.status !== 1) throw new Error('Producto no encontrado en Open Food Facts. ¬°Prueba otro c√≥digo!');
      return j.product;
    }

    function saveSearchHistory(code, name) {
      let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
      const newEntry = { code, name };
      // Elimina la entrada antigua si ya existe
      history = history.filter(item => item.code !== code);
      // A√±ade la nueva entrada al principio
      history.unshift(newEntry);
      // Limita el historial a 5 elementos
      history = history.slice(0, 5);
      localStorage.setItem('searchHistory', JSON.stringify(history));
      loadSearchHistory();
    }

    function loadSearchHistory() {
      const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
      const historyContainer = $('#history');
      historyContainer.innerHTML = '<div class="muted" style="font-size:0.8rem; margin-right:0.5rem;">Historial reciente:</div>';
      if (history.length > 0) {
        historyContainer.classList.remove('empty');
        history.forEach(item => {
          const button = document.createElement('button');
          button.classList.add('history-btn');
          button.textContent = item.name;
          button.onclick = () => {
            $('#input').value = item.code;
            run(item.code);
          };
          historyContainer.appendChild(button);
        });
      } else {
        historyContainer.classList.add('empty');
      }
    }

    async function run(code) {
      $('#score').textContent = '‚Ä¶';
      $('#scoreLabel').textContent = 'Calculando';
      try {
        const p = await fetchProduct(code);
        const s = computeHealthScore(p);
        updateUI(p, s);
        await loadAdditivesTaxonomy();
        updateUI(p, s);
        saveSearchHistory(p.code, p.product_name_es || p.product_name || p.code);
      } catch (e) {
        alert(e.message || 'Ocurri√≥ un error inesperado.');
        console.error(e);
        $('#score').textContent = '‚Äî';
        $('#scoreLabel').textContent = 'Error';
      }
    }

    const samples = {
      yogurt: '8410500006105',
      natillas: '8480000681379',
      galletas: '8434165611405'
    };

    $('#demoYogurt').onclick = () => { $('#input').value = samples.yogurt; $('#go').click(); };
    $('#demoNatillas').onclick = () => { $('#input').value = samples.natillas; $('#go').click(); };
    $('#demoGalletas').onclick = () => { $('#input').value = samples.galletas; $('#go').click(); };

    $('#go').onclick = () => {
      const code = parseCode($('#input').value);
      if (!code) {
        alert('Por favor, introduce un c√≥digo de barras (EAN) o una URL v√°lida de OpenFoodFacts.');
        return;
      }
      run(code);
    };

    $('#copy').onclick = () => {
      const text = [
        `Producto: ${$('#title').textContent || '‚Äî'}`,
        `Marca: ${$('#brand').textContent || '‚Äî'}`,
        `Categor√≠as: ${$('#cat').textContent || '‚Äî'}`,
        `Nota de saludabilidad: ${$('#score').textContent || '‚Äî'}/10 (${$('#scoreLabel').textContent || ''})`,
        `Nutri-Score: ${$('#nutri').textContent || '‚Äî'}`,
        `NOVA: ${$('#nova').textContent || '‚Äî'}`,
        `Az√∫cares/100g: ${$('#sugars').textContent || '‚Äî'}`,
        `Grasas sat./100g: ${$('#sats').textContent || '‚Äî'}`,
        `Sal/100g: ${$('#salt').textContent || '‚Äî'}`,
        `Ingredientes: ${$('#ing').textContent || '‚Äî'}`,
      ].join('\n');
      navigator.clipboard.writeText(text);
      alert('Resumen copiado al portapapeles. ‚úÖ');
    };
    // Carga el historial al iniciar la p√°gina
    document.addEventListener('DOMContentLoaded', loadSearchHistory);
  </script>
</body>
</html>
