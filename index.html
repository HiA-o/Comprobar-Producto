<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analizador de Alimentos ‚Äî Open Food Facts</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1020;
      --card: #131a33;
      --muted: #9aa3b2;
      --accent: #7cd992;
      --bad: #ef6262;
      --warn: #ffb020;
      --ok: #6cb4ff;
      --good: #7ee081;
      --text: #e5eef7;
      --border: #243056;
      --input-bg: #0b1328;
      --input-border: #33406a;
      --placeholder: #7b86a6;
      --button-bg: #1e2a52;
      --button-border: #2a3a6d;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Roboto', system-ui, sans-serif;
      background: linear-gradient(180deg, var(--bg) 0%, #0f1530 100%);
      color: var(--text);
      line-height: 1.5;
    }
    header {
      padding: 2.5rem 1rem 1rem;
      text-align: center;
    }
    h1 {
      margin: 0;
      font-size: clamp(2rem, 4vw, 3rem);
      letter-spacing: 0.4px;
    }
    p.sub {
      margin: 0.5rem 0 0;
      color: var(--muted);
      font-size: 1rem;
    }
    main {
      max-width: 1100px;
      margin: 1.5rem auto 3.5rem;
      padding: 0 1rem;
    }
    .panel {
      display: grid;
      gap: 1.5rem;
      grid-template-columns: 1.3fr 0.7fr;
    }
    @media (max-width: 980px) {
      .panel { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(5, 10, 30, 0.45);
      padding: 1.5rem;
    }
    .card h2 {
      font-size: 1.25rem;
      margin: 0 0 1rem;
    }
    label {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }
    input[type=text] {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      outline: none;
    }
    input[type=text]::placeholder { color: var(--placeholder); }
    .row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .row > * { flex: 1; }
    button {
      appearance: none;
      border: none;
      cursor: pointer;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      font-weight: 700;
      letter-spacing: 0.2px;
      background: var(--button-bg);
      color: var(--text);
      border: 1px solid var(--button-border);
      transition: filter 0.2s;
    }
    button:hover { filter: brightness(1.1); }
    .primary {
      background: linear-gradient(180deg, #2d6df6, #1f59cf);
      border-color: #1c4aa9;
    }
    .ghost { background: transparent; }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.75rem;
      color: #c8d1e3;
      padding: 0.4rem 0.6rem;
      border-radius: 999px;
      background: #0e1530;
      border: 1px solid #2c3a6a;
    }
    .scoreWrap {
      display: flex;
      gap: 1.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .score {
      font-size: 3.5rem;
      font-weight: 800;
      line-height: 1;
    }
    .score.bad { color: var(--bad); }
    .score.ok { color: var(--warn); }
    .score.good { color: var(--good); }
    .tag { font-weight: 700; color: #a9b4c9; }
    .grid {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    @media (max-width: 700px) {
      .grid { grid-template-columns: 1fr; }
    }
    .kv {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      padding: 0.6rem 0.8rem;
      border-radius: 0.75rem;
      background: #0c1530;
      border: 1px solid #25335f;
    }
    .kv .k { color: #a4afc8; font-size: 0.8rem; }
    .kv .v { font-weight: 700; }
    .list { display: grid; gap: 0.6rem; }
    .pill {
      padding: 0.7rem 0.8rem;
      border-radius: 0.75rem;
      background: #0c1530;
      border: 1px solid #273768;
    }
    .pill .title { font-weight: 700; }
    .pill.small { font-size: 0.8rem; }
    .warn { color: var(--warn); }
    .bad { color: var(--bad); }
    .good { color: var(--good); }
    .muted { color: var(--muted); }
    .flex {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .flex-col {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .divider {
      height: 1px;
      background: #25335f;
      margin: 1rem 0;
    }
    .foot {
      font-size: 0.75rem;
      color: #9aa8c2;
      text-align: center;
      margin-top: 1.5rem;
    }
    .tiny { font-size: 0.75rem; color: #9db0cf; }
    .tooltip {
      border-bottom: 1px dotted #7385af;
      cursor: help;
    }
    .right { justify-content: flex-end; }
    .scorebar {
      height: 0.75rem;
      border-radius: 999px;
      background: #0b1328;
      border: 1px solid #33406a;
      position: relative;
      overflow: hidden;
    }
    .scorebar > i {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0;
      background: linear-gradient(90deg, var(--bad), var(--warn), var(--good));
      transition: width 0.5s ease-out;
    }
    .badge {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #2b3967;
      background: #0c1530;
      color: #c9d2e7;
    }
    .notes {
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 0.75rem;
      background: #0a1226;
      border: 1px dashed #2d3d71;
      padding: 0.8rem;
      border-radius: 0.75rem;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>Analizador de alimentos ‚Äî Open Food Facts</h1>
    <p class="sub">Pega el c√≥digo de barras o la URL de <b>Open Food Facts</b>, y te doy un resumen + <span class="tooltip" title="Reglas heur√≠sticas basadas en az√∫car, grasas, sal, NOVA, aditivos y otros">nota de saludabilidad</span>.</p>
  </header>
  <main>
    <section class="panel">
      <div class="card">
        <h2>üîç Entrada</h2>
        <label for="input">C√≥digo de barras (EAN) o URL del producto</label>
        <div class="row">
          <input id="input" type="text" placeholder="Ej.: 8410100082930 o https://es.openfoodfacts.org/producto/8410100082930" />
          <button class="primary" id="go">Analizar</button>
        </div>
        <div class="row" style="margin-top:0.75rem">
          <button id="demoYogurt" class="ghost">Probar con Yogur üçì</button>
          <button id="demoNatillas" class="ghost">Probar con Natillas üçÆ</button>
          <button id="demoGalletas" class="ghost">Probar con Galletas üç™</button>
        </div>
        <div class="row" style="margin-top:1rem">
          <span class="chip"><input type="checkbox" id="strict" /> <label for="strict" style="margin:0; cursor:pointer">Modo estricto</label></span>
          <span class="chip"><input type="checkbox" id="useNutri" checked /> <label for="useNutri" style="margin:0; cursor:pointer">Usar Nutri-Score</label></span>
        </div>
      </div>
      <div class="card">
        <h2>‚ú® Nota de saludabilidad</h2>
        <div class="scoreWrap">
          <div class="score bad" id="score">‚Äî</div>
          <div>
            <div id="scoreLabel" class="tag">‚Äî</div>
            <div class="scorebar" style="margin-top:0.5rem"><i id="scoreBar"></i></div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="grid">
          <div class="kv"><div class="k">Nutri-Score</div><div class="v" id="nutri">‚Äî</div></div>
          <div class="kv"><div class="k">NOVA (procesado)</div><div class="v" id="nova">‚Äî</div></div>
          <div class="kv"><div class="k">Aditivos</div><div class="v" id="additivesCount">‚Äî</div></div>
          <div class="kv"><div class="k">Az√∫cares /100g</div><div class="v" id="sugars">‚Äî</div></div>
          <div class="kv"><div class="k">Grasas sat. /100g</div><div class="v" id="sats">‚Äî</div></div>
          <div class="kv"><div class="k">Sal /100g</div><div class="v" id="salt">‚Äî</div></div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:1.5rem">
      <div class="flex right"><button id="copy" class="ghost">Copiar resumen</button></div>
      <div class="flex">
        <img id="img" alt="imagen" style="width:5.5rem; height:5.5rem; object-fit:cover; border-radius:0.75rem; border:1px solid #2a3966; background:#0a1226;" />
        <div class="flex-col">
          <div style="font-weight:800; font-size:1.25rem" id="title">‚Äî</div>
          <div class="tiny" id="brand">‚Äî</div>
          <div class="tiny" id="cat">‚Äî</div>
          <div class="flex" style="margin-top:0.4rem; gap:0.4rem">
            <span id="nutriBadge" class="badge" style="display:none"></span>
            <span id="novaBadge" class="badge" style="display:none"></span>
            <span id="ecoBadge" class="badge" style="display:none"></span>
          </div>
        </div>
      </div>
      <div class="divider"></div>
      <h2>üö¶ Se√±ales clave</h2>
      <div class="grid">
        <div class="pill"><div class="title">Ingredientes</div><div class="muted" id="ing">‚Äî</div></div>
        <div class="pill"><div class="title">Nutrientes /100g</div><div class="muted" id="nutr"></div></div>
      </div>
      <div class="divider"></div>
      <h2>üß™ Aditivos y evaluaci√≥n</h2>
      <div class="list" id="additivesList"><div class="muted">‚Äî</div></div>
      <div class="divider"></div>
      <h2>üìù Motivos de la nota</h2>
      <div class="list" id="reasons"><div class="muted">‚Äî</div></div>
      <div class="divider"></div>
      <details>
        <summary class="tiny">Depuraci√≥n (detalles t√©cnicos)</summary>
        <pre class="notes" id="debug">‚Äî</pre>
      </details>
      <p class="foot">Fuente de datos: Open Food Facts (API p√∫blica). Esta app no almacena nada.</p>
    </section>
  </main>
  <script>
    const $ = s => document.querySelector(s);
    const fmt = n => (n == null || isNaN(n)) ? '‚Äî' : (Math.round(n * 10) / 10).toString();
    const clamp = (x, a, b) => Math.min(Math.max(x, a), b);

    // Penalizaciones suaves/medias por se√±ales controvertidas
    const controversial = {
      'en:e223': { level: 'media', note: 'Conservante (sulfitos). Puede causar reacciones en sensibles.' },
      'en:e150d': { level: 'media', note: 'Colorante caramelo con amonio-sulfitos.' },
      'en:e407': { level: 'media', note: 'Carragenanos: espesante controvertido.' },
      'en:e950': { level: 'media', note: 'Acesulfamo K (edulcorante).' },
      'en:e951': { level: 'media', note: 'Aspartamo (edulcorante).' },
      'en:e954': { level: 'media', note: 'Sacarina (edulcorante).' },
      'en:e621': { level: 'baja', note: 'Glutamato monos√≥dico (potenciador del sabor).' },
      'en:e250': { level: 'alta', note: 'Nitrito s√≥dico en c√°rnicos.' },
      'en:e251': { level: 'media', note: 'Nitrato s√≥dico; precursor de nitritos.' }
    };

    let additivesTaxonomy = null;
    async function loadAdditivesTaxonomy() {
      if (additivesTaxonomy) return additivesTaxonomy;
      try {
        const res = await fetch('https://static.openfoodfacts.org/data/taxonomies/additives.json', { mode: 'cors' });
        additivesTaxonomy = await res.json();
      } catch (e) {
        console.warn('No se pudo cargar la taxonom√≠a de aditivos', e);
        additivesTaxonomy = {};
      }
      return additivesTaxonomy;
    }

    const tagToEcode = tag => tag?.split(':').pop()?.toUpperCase() || '';
    const gradeColor = score => score >= 8 ? 'good' : score >= 6 ? 'ok' : 'bad';
    const percentBar = score => (score / 10 * 100).toFixed(1) + '%';
    const nutriBadge = g => g ? `Nutri-Score ${('' + g).toUpperCase()}` : '';
    const novaBadge = n => n ? `NOVA ${n}` : '';

    function computeHealthScore(p, opts) {
      const o = { strict: !!opts?.strict, useNutri: !!opts?.useNutri };
      const N = p.nutriments || {};
      const sugars = N.sugars_100g ?? N.sugars ?? null;
      const sat = N['saturated-fat_100g'] ?? N['saturated-fat'] ?? null;
      const salt = N.salt_100g ?? N.salt ?? (N.sodium_100g ? N.sodium_100g * 2.5 : null);
      const fiber = N.fiber_100g ?? N.fiber ?? null;
      const protein = N.proteins_100g ?? N.proteins ?? null;
      const nova = p.nova_group || p.nova_groups || null;

      let score = 10;
      const reasons = [];

      // Penalizaciones y bonificaciones
      if (nova) {
        if (nova == 4) { score -= o.strict ? 2.5 : 2; reasons.push(`NOVA 4 (ultraprocesado) ‚Üí -${o.strict ? 2.5 : 2}`); }
        else if (nova == 3) { score -= 1.2; reasons.push('NOVA 3 (procesado) ‚Üí -1.2'); }
        else if (nova == 2) { score -= 0.2; reasons.push('NOVA 2 (m√≠nimo procesado) ‚Üí -0.2'); }
      }
      if (sugars != null) {
        if (sugars > 12) { score -= o.strict ? 3.2 : 2.8; reasons.push(`Az√∫car ${fmt(sugars)} g/100g ‚Üí -${o.strict ? 3.2 : 2.8}`); }
        else if (sugars > 8) { score -= 2.0; reasons.push(`Az√∫car ${fmt(sugars)} g/100g ‚Üí -2.0`); }
        else if (sugars > 5) { score -= 1.2; reasons.push(`Az√∫car ${fmt(sugars)} g/100g ‚Üí -1.2`); }
        else if (sugars === 0) { score += 0.4; reasons.push('Sin az√∫cares ‚Üí +0.4'); }
      }
      if (sat != null) {
        if (sat > 8) { score -= 2.0; reasons.push(`Grasas sat. ${fmt(sat)} g/100g ‚Üí -2.0`); }
        else if (sat > 5) { score -= 1.0; reasons.push(`Grasas sat. ${fmt(sat)} g/100g ‚Üí -1.0`); }
        else if (sat <= 1) { score += 0.2; reasons.push('Grasas sat. bajas ‚Üí +0.2'); }
      }
      if (salt != null) {
        if (salt > 1.5) { score -= 1.5; reasons.push(`Sal ${fmt(salt)} g/100g ‚Üí -1.5`); }
        else if (salt > 0.9) { score -= 0.8; reasons.push(`Sal ${fmt(salt)} g/100g ‚Üí -0.8`); }
        else if (salt < 0.12) { score += 0.2; reasons.push('Sal muy baja ‚Üí +0.2'); }
      }
      if (fiber != null) {
        if (fiber >= 6) { score += 0.8; reasons.push('Fibra ‚â•6 g/100g ‚Üí +0.8'); }
        else if (fiber >= 3) { score += 0.4; reasons.push('Fibra ‚â•3 g/100g ‚Üí +0.4'); }
      }
      if (protein != null) {
        if (protein >= 8) { score += 0.5; reasons.push('Prote√≠na ‚â•8 g/100g ‚Üí +0.5'); }
        else if (protein < 3) { score -= 0.4; reasons.push('Prote√≠na baja ‚Üí -0.4'); }
      }
      const fvn = p['fruits-vegetables-nuts_100g'] ?? p.fruits_vegetables_nuts_estimate_100g ?? null;
      if (fvn != null) {
        if (fvn >= 40) { score += 0.4; reasons.push('Buena proporci√≥n de FVH ‚Üí +0.4'); }
        else if (fvn === 0) { score -= 0.6; reasons.push('0% fruta/verdura/nueces ‚Üí -0.6'); }
      }

      const adds = p.additives_tags || [];
      if (adds.length >= 6) { score -= 1.6; reasons.push(`Muchos aditivos (${adds.length}) ‚Üí -1.6`); }
      else if (adds.length >= 3) { score -= 0.8; reasons.push(`Varios aditivos (${adds.length}) ‚Üí -0.8`); }
      let controversialHits = 0;
      let highFlag = false;
      for (const t of adds) {
        if (controversial[t]) {
          controversialHits++;
          if (controversial[t].level === 'alta') { score -= 1.0; highFlag = true; }
          else { score -= 0.5; }
        }
      }
      if (controversialHits > 0) { reasons.push(`Aditivos controvertidos: ${controversialHits}${highFlag ? ' (incluye ALTA)' : ''}`); }
      
      const ingTxt = (p.ingredients_text_es || p.ingredients_text || '').toLowerCase();
      if (ingTxt.includes('aroma')) {
        const hasFruitWord = /(fresa|frambuesa|manzana|pl√°tano|banana|pera|melocot√≥n|cacao|vainilla|lim√≥n|naranja|uva|fruta)/.test(ingTxt);
        if (!hasFruitWord) { score -= 0.6; reasons.push('Aromas a√±adidos sin fruta destacada ‚Üí -0.6'); }
        else { score -= 0.4; reasons.push('Aromas a√±adidos ‚Üí -0.4'); }
      }
      
      const nutriGrade = p.nutriscore_grade || p.nutrition_grades || p.nutrition_grade_fr || null;
      if (o.useNutri && nutriGrade) {
        const g = ('' + nutriGrade).toLowerCase();
        const adj = { 'a': +0.6, 'b': +0.2, 'c': -0.6, 'd': -1.2, 'e': -1.8 }[g];
        if (adj) { score += adj; reasons.push(`Nutri-Score ${g.toUpperCase()} ‚Üí ${adj > 0 ? '+' : ''}${adj}`); }
      }

      score = clamp(Math.round(score * 10) / 10, 1, 10);
      let label = 'Mejor evitar';
      if (score >= 8) label = 'Excelente para consumo habitual';
      else if (score >= 6) label = 'Aceptable / consumo moderado';
      else if (score >= 4) label = 'Ocasional';

      return { score, label, sugars, sat, salt, fiber, protein, nova, reasons };
    }

    function updateUI(p, s) {
      // Score section
      const scoreEl = $('#score');
      scoreEl.textContent = s.score.toFixed(1);
      scoreEl.classList.remove('bad', 'ok', 'good');
      scoreEl.classList.add(gradeColor(s.score));
      $('#scoreLabel').textContent = s.label;
      $('#scoreBar').style.width = percentBar(s.score);
      $('#sugars').textContent = s.sugars != null ? `${fmt(s.sugars)} g` : '‚Äî';
      $('#sats').textContent = s.sat != null ? `${fmt(s.sat)} g` : '‚Äî';
      $('#salt').textContent = s.salt != null ? `${fmt(s.salt)} g` : '‚Äî';
      $('#nutri').textContent = p.nutriscore_grade || p.nutrition_grades || p.nutrition_grade_fr || '‚Äî';
      $('#nova').textContent = p.nova_group || p.nova_groups || '‚Äî';
      $('#additivesCount').textContent = (p.additives_tags || []).length;

      // Product basics
      $('#title').textContent = p.product_name_es || p.product_name || 'Producto sin nombre';
      $('#brand').textContent = p.brands || '‚Äî';
      $('#cat').textContent = p.categories || '‚Äî';
      $('#img').src = p.image_small_url || p.image_url || '';

      const g = p.nutriscore_grade || p.nutrition_grades || p.nutrition_grade_fr;
      const n = p.nova_group || p.nova_groups;
      $('#nutriBadge').style.display = g ? 'inline-block' : 'none';
      if (g) $('#nutriBadge').textContent = nutriBadge(g);
      $('#novaBadge').style.display = n ? 'inline-block' : 'none';
      if (n) $('#novaBadge').textContent = novaBadge(n);

      // Ingredients & nutrients
      const ingredientsText = (p.ingredients_text_es || p.ingredients_text || '‚Äî');
const cleanedIngredients = ingredientsText.replace(/_/g, '');
$('#ing').textContent = cleanedIngredients;
      const N = p.nutriments || {};
      $('#nutr').innerHTML = [
        N['energy-kcal_100g'] ? `Energ√≠a: ${fmt(N['energy-kcal_100g'])} kcal` : null,
        N.fat_100g != null ? `Grasa: ${fmt(N.fat_100g)} g` : null,
        N['saturated-fat_100g'] != null ? `Sat.: ${fmt(N['saturated-fat_100g'])} g` : null,
        N.carbohydrates_100g != null ? `Hidratos: ${fmt(N.carbohydrates_100g)} g` : null,
        N.sugars_100g != null ? `Az√∫cares: ${fmt(N.sugars_100g)} g` : null,
        N.fiber_100g != null ? `Fibra: ${fmt(N.fiber_100g)} g` : null,
        N.proteins_100g != null ? `Prote√≠nas: ${fmt(N.proteins_100g)} g` : null,
        N.salt_100g != null ? `Sal: ${fmt(N.salt_100g)} g` : (N.sodium_100g != null ? `Sodio: ${fmt(N.sodium_100g)} g` : null)
      ].filter(Boolean).join(' ¬∑ ');

    // Additives
      const list = $('#additivesList');
      list.innerHTML = '';
      const tags = p.additives_tags || [];

      if (tags.length === 0) {
        list.innerHTML = '<div class="muted">Sin aditivos declarados.</div>';
      } else {
        const tax = additivesTaxonomy || {};
        tags.forEach(t => {
          const info = tax[t] || {};
          const name = (info.name_es || info.name_es_es || info.name_en || {});
          const disp = typeof name === "string" ? name : (name?.es || name?.en || name?.fr || tagToEcode(t));
          const cont = controversial[t];
          
          const extra = [];
          const risk = info.efsa_evaluation_overexposure_risk || info.efsa_evaluation || null;
          if (risk) {
            let riskText = 'Evaluaci√≥n EFSA.';
            if (typeof risk === "string") {
              if (risk.toLowerCase().includes('re-evaluation')) { riskText = 'EFSA: En re-evaluaci√≥n o ya evaluado.'; }
              else if (risk.toLowerCase().includes('safe')) { riskText = 'EFSA: Considerado seguro.'; }
            }
            extra.push(riskText);
          }

          const veg = info.vegan || info.vegetarian || null;
          if (veg) {
            const vegNote = typeof veg === "string" ? veg : (veg?.en || '');
            if (vegNote.toLowerCase().includes('no')) { extra.push('No apto para veganos/vegetarianos'); }
            else if (vegNote.toLowerCase().includes('yes')) { extra.push('Apto para veganos/vegetarianos'); }
          }

          if (cont) {
            extra.push(`Nota: ${cont.note}`);
          }

          const html = `<div class="pill small"><div class="title">${tagToEcode(t)} ‚Äî ${disp || tagToEcode(t)}</div><div class="tiny">${extra.join(' ¬∑ ') || 'Sin informaci√≥n adicional.'}</div></div>`;
          list.insertAdjacentHTML('beforeend', html);
        });
      }

      // Reasons
      const reasonsBox = $('#reasons');
      reasonsBox.innerHTML = '';
      if (!s.reasons.length) {
        reasonsBox.innerHTML = '<div class="muted">‚Äî</div>';
      } else {
        s.reasons.forEach(x => reasonsBox.insertAdjacentHTML('beforeend', `<div class="pill small">${x}</div>`));
      }
      
      // Debug
      const debugData = {
        product: { code: p.code, name: p.product_name, nutri: g, nova: n },
        nutriments: { ...N },
        additives_tags: p.additives_tags || [],
        reasons: s.reasons,
        score: s.score
      };
      $('#debug').textContent = JSON.stringify(debugData, null, 2);
    }

    const parseCode = input => {
      input = (input || '').trim();
      if (!input) return null;
      if (input.startsWith('http')) {
        try {
          const u = new URL(input);
          const m = u.pathname.match(/(\d{8,14})/);
          return m?.[1] || null;
        } catch (e) { return null; }
      }
      const m = input.match(/^(\d{8,14})$/);
      return m?.[1] || null;
    };

    async function fetchProduct(code) {
      const url = `https://world.openfoodfacts.org/api/v2/product/${code}.json`;
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error('Error al conectar con Open Food Facts.');
      const j = await res.json();
      if (j.status !== 1) throw new Error('Producto no encontrado en Open Food Facts. ¬°Prueba otro c√≥digo!');
      return j.product;
    }

    async function run(code) {
      $('#score').textContent = '‚Ä¶';
      $('#scoreLabel').textContent = 'Calculando';
      try {
        const p = await fetchProduct(code);
        const s = computeHealthScore(p, { strict: $('#strict').checked, useNutri: $('#useNutri').checked });
        updateUI(p, s);
        await loadAdditivesTaxonomy();
        updateUI(p, s); // Second update to include additives info
      } catch (e) {
        alert(e.message || 'Ocurri√≥ un error inesperado.');
        console.error(e);
        $('#score').textContent = '‚Äî';
        $('#scoreLabel').textContent = 'Error';
      }
    }

    const samples = {
      yogurt: '8410500006105',
      natillas: '8480000681379',
      galletas: '8434165611405'
    };

    $('#demoYogurt').onclick = () => { $('#input').value = samples.yogurt; $('#go').click(); };
    $('#demoNatillas').onclick = () => { $('#input').value = samples.natillas; $('#go').click(); };
    $('#demoGalletas').onclick = () => { $('#input').value = samples.galletas; $('#go').click(); };

    $('#go').onclick = () => {
      const code = parseCode($('#input').value);
      if (!code) {
        alert('Por favor, introduce un c√≥digo de barras (EAN) o una URL v√°lida de OpenFoodFacts.');
        return;
      }
      run(code);
    };

    $('#copy').onclick = () => {
      const text = [
        `Producto: ${$('#title').textContent || '‚Äî'}`,
        `Marca: ${$('#brand').textContent || '‚Äî'}`,
        `Categor√≠as: ${$('#cat').textContent || '‚Äî'}`,
        `Nota de saludabilidad: ${$('#score').textContent || '‚Äî'}/10 (${$('#scoreLabel').textContent || ''})`,
        `Nutri-Score: ${$('#nutri').textContent || '‚Äî'}`,
        `NOVA: ${$('#nova').textContent || '‚Äî'}`,
        `Az√∫cares/100g: ${$('#sugars').textContent || '‚Äî'}`,
        `Grasas sat./100g: ${$('#sats').textContent || '‚Äî'}`,
        `Sal/100g: ${$('#salt').textContent || '‚Äî'}`,
        `Ingredientes: ${$('#ing').textContent || '‚Äî'}`,
      ].join('\n');
      navigator.clipboard.writeText(text);
      alert('Resumen copiado al portapapeles. ‚úÖ');
    };
  </script>
</body>
</html>
